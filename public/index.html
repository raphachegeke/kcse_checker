<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCSE RESULT FINDER (Live)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background-color: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, button { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ddd; }
        button { background-color: #007BFF; color: white; border: none; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px;}
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Stats Box */
        #stats-box { 
            display: none; 
            margin-top: 15px; 
            padding: 15px; 
            background-color: #e9ecef; 
            border-radius: 4px; 
            text-align: center;
            font-size: 1.1em;
            color: #333;
            border-left: 5px solid #007BFF;
        }
        .highlight-num { font-weight: bold; font-size: 1.2em; color: #007BFF; }

        #results { margin-top: 30px; }
        
        .match-card { 
            border-left: 5px solid #28a745; 
            padding: 15px; 
            margin-bottom: 15px; 
            background-color: #ffffff; 
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }

        .match-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .match-index { font-size: 1.2em; font-weight: bold; color: #333; }
        .match-grade { background-color: #28a745; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
        .match-detail { font-size: 0.95em; margin: 5px 0; color: #555; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
       .findSchool{
            text-decoration: none;
            color: blue;
            
       }
       .rapha{
            text-content: center;
            align-items: center;
            text-decoration: none;
            color: #28a745;
       }
    </style>
</head>
<body>

    <div class="card">
        <h1>KCSE RESULT FINDER </h1>
        <p>
            Enter any of your name and School code.
            <a href="https://raphachegekamunu.vercel.app" class="findSchool">Made with ðŸ’ž by Rapha</a>
        </p>

        <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" value="" placeholder="e.g. Leon">
        </div>

        <div class="form-group">
            <label>School Code</label>
            <input type="text" id="baseIndex" value="" placeholder="e.g. 21436587" max="8">
            <a class="findSchool" href="https://teacher.co.ke/knec-codes-for-kenyan-schools" target="_blank">Find your school code?</a>
        </div>

        <div class="form-group" style="display:flex; gap:10px;">
            <div>
                <label>First Index</label>
                <input type="number" id="start" value="001">
            </div>
            <div>
                <label>Last Index</label>
                <input type="number" id="end" value="200">
            </div>
        </div>

        <button id="scanBtn" onclick="startScan()">Start Scan</button>
     
        
        <!-- Live Stats Box -->
        <div id="stats-box">
            Scanning... <br>
            Items remaining: <span id="remaining-count" class="highlight-num">--</span>
        </div>
    </div>

    <div id="results"></div>

    <script>
        async function startScan() {
            const btn = document.getElementById('scanBtn');
            const resultsDiv = document.getElementById('results');
            const statsBox = document.getElementById('stats-box');
            const remainingSpan = document.getElementById('remaining-count');
            
            const name = document.getElementById('name').value;
            const baseIndex = document.getElementById('baseIndex').value;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            if(!name || !baseIndex) {
                alert("Please fill in all fields");
                return;
            }

            // Reset UI
            btn.disabled = true;
            btn.innerText = "Scanning in progress...";
            resultsDiv.innerHTML = "";
            statsBox.style.display = 'block';
            remainingSpan.innerText = "Calculating...";

            try {
                // 1. Initiate the request
                const response = await fetch('/api/check-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, baseIndex, start, end })
                });

                // 2. Set up the reader to handle the stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }

                    // 3. Decode the chunk of data
                    buffer += decoder.decode(value, { stream: true });

                    // 4. Split by new lines to handle individual events
                    const lines = buffer.split('\n');
                    // Keep the last partial line in the buffer
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.replace('data: ', '');
                                const data = JSON.parse(jsonStr);

                                // Handle Progress Updates
                                if (data.type === 'progress') {
                                    remainingSpan.innerText = data.remaining;
                                }

                                // Handle New Results
                                if (data.type === 'result') {
                                    addResultCard(data);
                                }

                                // Handle Done
                                if (data.type === 'done') {
                                    btn.disabled = false;
                                    btn.innerText = "Start Scan";
                                    statsBox.style.display = 'none';
                                    if(resultsDiv.innerHTML === "") {
                                        resultsDiv.innerHTML = "<div class='card'><p>No matches found.</p></div>";
                                    }
                                }
                            } catch (e) {
                                console.error("Error parsing stream data", e);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error(error);
                alert("Error connecting to server.");
                btn.disabled = false;
                btn.innerText = "Start Scan";
            }
        }

        function addResultCard(data) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'match-card';
            div.innerHTML = `
                <div class="match-header">
                    <span class="match-index">${data.index}</span>
                    <span class="match-grade">${data.grade}</span>
                </div>
                <div class="match-detail"><strong>Name:</strong> ${data.realName}</div>
            `;
            // Add new result to the top
            resultsDiv.prepend(div);
        }
    </script>
</body>
</html>